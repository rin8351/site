{% load static %}
{% load i18n %}


<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>RTLM</title>
  <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/search.css' %}">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">
  <link rel="shortcut icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/favicon.ico' %}">
</head>

<body class="day-mode">

  <header>
    <div class="theme-switcher" id="theme-switcher">
      <img src="{% static 'img/day.png' %}" alt="Дневной режим" id="sun-icon" style="display: none;">
      <img src="{% static 'img/night.png' %}" alt="Ночной режим" id="moon-icon">
    </div>
<form action="/i18n/setlang/" method="post" id="language-form">
    {% csrf_token %}
    <input name="next" type="hidden" value="{{ redirect_to }}" />
    <select name="language" id="language-select">
      {% get_current_language as LANGUAGE_CODE %}
      {% get_available_languages as LANGUAGES %}
        {% for lang in LANGUAGES %}
            <option value="{{ lang.0 }}" {% if lang.0 == LANGUAGE_CODE %} selected {% endif %}>
                {{ lang.1 }}
            </option>
        {% endfor %}
    </select>
  </form>
  </header>

  <main>
    <div class="text-block">  
    <h1>Radio Télévision Libre des Mémoire</h1>
    <p>{{ description|linebreaksbr }}</p>
  </div>

  <div>  
    <div class="text-block">
      <a href="https://www.1tv.ru/live" class="image-link">
        <img src="{% static 'img/1tv.png' %}" alt="1tv">
      </a>
      <p>
        <a href="https://storage.googleapis.com/rtlm/2023_ORT.zip">2023.11.05 - 2024 # ORT</a>
      </p>
    </div>

    <div class="text-block">
      <a href="https://www.tvr.by/televidenie/belarus-1" class="image-link">
        <img src="{% static 'img/belarus-1.png' %}" alt="belarus-1">
      </a>
      <p>
        <a href="https://storage.googleapis.com/rtlm/2023_belarusone.zip">2023.11.12 - 2024 # Belarus 1</a>
      </p>
    </div>

    <div class="text-block">
      <a href="https://1plus1.video/tvguide/1plus1/online" class="image-link">
        <img src="{% static 'img/1plus1.png' %}" alt="1plus1">
      </a>
      <p>
        <a href="https://storage.googleapis.com/rtlm/2023_oneplusone.zip">2023.11.12 - 2024 # 1+1</a>
      </p>
    </div>

    <div class="text-block">
      <a href="https://smotrim.ru/live/63254" class="image-link">
        <img src="{% static 'img/rossia.png' %}" alt="ros1">
      </a>
      <p>
        <a href="https://storage.googleapis.com/rtlm/2023_russiaone.zip">2023.11.26 - 2024 # Russia 1</a>
      </p>
    </div>

    <div class="text-block">
      <p>
        Colab samples:<br>
        <a href="https://colab.research.google.com/drive/1R5AtTIYjtWmcKIqbgJS08Rl7IkmyCrEs?usp=sharing">Text search colab</a>
        <br>
        Instruction at <a href="https://youtu.be/qBTsEPCBc0Q">Youtube</a>
      </p>
    </div>

    <div class="text-block">
      <p>{{ ds|linebreaksbr }}</p>
    </div>
  </div>

  <div class="text-block">
    <h2>{% trans "Word Search" %}</h2>
    <div id="search-root"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/victory/dist/victory.min.js"></script>
    
    {% csrf_token %}
    <script>
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const WordSearchViz = () => {
            const [searchTerm, setSearchTerm] = React.useState('');
            const [data, setData] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState(null);

            const colors = {
                'ORT': '#264653',
                'belarusone': '#2A9D8F',
                'oneplusone': '#E9C46A',
                'russiaone': '#E63946'
            };

            const handleSearch = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError(null);
                
                console.log('Sending search request:', searchTerm);

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ searchTerm: searchTerm.trim() })
                    });

                    console.log('Response status:', response.status);
                    console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                    
                    const contentType = response.headers.get('content-type');
                    console.log('Content-Type:', contentType);

                    const responseText = await response.text();
                    console.log('Raw response:', responseText);
                    
                    if (!response.ok) {
                        throw new Error(`Search failed: ${response.status} ${response.statusText}`);
                    }
                    
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('Server returned non-JSON response');
                    }
                    
                    const results = JSON.parse(responseText);
                    console.log('Parsed results:', results);
                    
                    setData(results);
                } catch (err) {
                    console.error('Search error:', err);
                    setError(`Error: ${err.message}`);
                    setData([]);
                } finally {
                    setIsLoading(false);
                }
            };

            return React.createElement('div', { className: 'search-container' },
                React.createElement('form', { onSubmit: handleSearch },
                    React.createElement('input', {
                        type: 'text',
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        placeholder: 'Enter search terms...',
                        className: 'search-input'
                    }),
                    React.createElement('button', {
                        type: 'submit',
                        disabled: isLoading
                    }, isLoading ? 'Searching...' : 'Search')
                ),
                error && React.createElement('div', { className: 'error' }, error),
                data.length > 0 && React.createElement(Victory.VictoryChart, {
                    scale: { x: "time" },
                    containerComponent: React.createElement(Victory.VictoryVoronoiContainer)
                },
                    Object.keys(colors).map(channel => 
                        React.createElement(Victory.VictoryLine, {
                            key: channel,
                            data: data.map(d => ({
                                x: new Date(d.date),
                                y: d[channel]
                            })),
                            style: { data: { stroke: colors[channel] } }
                        })
                    )
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('search-root'));
        root.render(React.createElement(WordSearchViz));
    </script>
  </div>

  </main>

  <footer>

    <a href="https://patreon.com/rtlm" class="image-link">
        <img src="{% static 'img/pat.png' %}" alt="Patreon">
    </a>
    <a href="https://t.me/rtlminfo" class="image-link">
        <img src="{% static 'img/tel.png' %}" alt="Telegram">
    </a>  

  </footer>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
  const themeSwitcher = document.getElementById('theme-switcher');
  const sunIcon = document.getElementById('sun-icon');
  const moonIcon = document.getElementById('moon-icon');
  let currentTheme = localStorage.getItem('theme') || 'day-mode';

  updateTheme(currentTheme);

  themeSwitcher.addEventListener('click', function() {
    currentTheme = currentTheme === 'day-mode' ? 'night-mode' : 'day-mode';
    localStorage.setItem('theme', currentTheme);
    updateTheme(currentTheme);
  });

  function updateTheme(theme) {
    if (theme === 'night-mode') {
      document.body.classList.remove('day-mode');
      document.body.classList.add('night-mode');
      sunIcon.style.display = 'none';
      moonIcon.style.display = 'block';
    } else {
      document.body.classList.remove('night-mode');
      document.body.classList.add('day-mode');
      sunIcon.style.display = 'block';
      moonIcon.style.display = 'none';
    }
  }
});


  </script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var languageSelect = document.getElementById('language-select');
        languageSelect.addEventListener('change', function() {
          this.form.submit();
        });
      });
    </script>
</body>
</html>