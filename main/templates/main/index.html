{% load static %}
{% load i18n %}


<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>RTLM</title>
  <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/search.css' %}">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">
  <link rel="shortcut icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/favicon.ico' %}">
</head>

<body class="day-mode">

  <header>
    <div class="theme-switcher" id="theme-switcher">
      <img src="{% static 'img/day.png' %}" alt="–î–Ω–µ–≤–Ω–æ–π —Ä–µ–∂–∏–º" id="sun-icon" style="display: none;">
      <img src="{% static 'img/night.png' %}" alt="–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º" id="moon-icon">
    </div>
<form action="/i18n/setlang/" method="post" id="language-form">
    {% csrf_token %}
    <input name="next" type="hidden" value="{{ redirect_to }}" />
    <select name="language" id="language-select">
      {% get_current_language as LANGUAGE_CODE %}
      {% get_available_languages as LANGUAGES %}
        {% for lang in LANGUAGES %}
            <option value="{{ lang.0 }}" {% if lang.0 == LANGUAGE_CODE %} selected {% endif %}>
                {{ lang.1 }}
            </option>
        {% endfor %}
    </select>
  </form>
  </header>

  <main>
    <div class="text-block" style="text-align: center;">  
    <h1>Radio T√©l√©vision Libre des M√©moire</h1>
    <p>{{ description|linebreaksbr }}</p>
  </div>

  <div class="text-block">
    <div id="search-root"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
    
    {% csrf_token %}
    <script>
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const WordSearchViz = () => {
            const [searchTerm, setSearchTerm] = React.useState('');
            const [data, setData] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const chartRef = React.useRef(null);

            const colors = {
                'ORT': '#264653',
                'belarusone': '#2A9D8F',
                'oneplusone': '#E9C46A',
                'russiaone': '#E63946'
            };

            const channels = ['ORT', 'belarusone', 'oneplusone', 'russiaone'];

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const handleSearch = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError(null);

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: JSON.stringify({ searchTerm: searchTerm.trim() })
                    });

                    if (!response.ok) {
                        throw new Error('Search failed. Please try again.');
                    }

                    const results = await response.json();
                    setData(results);

                    if (results.length > 0) {
                        const traces = channels.map(channel => ({
                            x: results.map(item => item.date),
                            y: results.map(item => item[channel]),
                            mode: 'lines+markers',
                            name: channel,
                            line: { color: colors[channel] },
                            marker: { color: colors[channel] }
                        }));

                        const layout = {
                            title: {
                                text: `RTLM.info Word Frequency search: "${searchTerm}"`,
                                y: 0.95
                            },
                            xaxis: { 
                                title: 'Date',
                                gridcolor: '#EDEDED'
                            },
                            yaxis: { 
                                title: 'Occurrences',
                                gridcolor: '#EDEDED'
                            },
                            paper_bgcolor: 'rgba(0,0,0,0)',
                            plot_bgcolor: 'rgba(0,0,0,0)',
                            hovermode: 'closest',
                            margin: { t: 120, r: 20, b: 50, l: 50 },
                            showlegend: true,
                            legend: {
                                x: 0.5,
                                y: 1.15,
                                xanchor: 'center',
                                yanchor: 'bottom',
                                orientation: 'h'
                            }
                        };

                        const config = {
                            responsive: true,
                            displayModeBar: true,
                            displaylogo: false,
                            modeBarButtonsToRemove: [
                                'zoom2d',
                                'zoomIn2d', 
                                'zoomOut2d',
                                'resetScale2d',
                                'hoverClosestCartesian',
                                'hoverCompareCartesian',
                                'toggleSpikelines',
                                'lasso2d'
                            ],
                            displayModeBar: 'hover'
                        };

                        Plotly.newPlot(chartRef.current, traces, layout, config);
                    }
                } catch (err) {
                    setError(err.message);
                    setData([]);
                } finally {
                    setIsLoading(false);
                }
            };

            return React.createElement('div', { className: 'search-container' },
                React.createElement('form', { onSubmit: handleSearch },
                    React.createElement('input', {
                        type: 'text',
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        placeholder: 'Enter word or sentence...',
                        className: 'search-input'
                    }),
                    React.createElement('button', {
                        type: 'submit',
                        disabled: isLoading
                    }, isLoading ? 'Searching...' : 'Search')
                ),
                React.createElement('div', {
                    className: 'text-sm text-gray-500 mb-2 italic'
                }, data.length > 0 && 'üí° Tip: Use middle mouse button and drag horizontally to zoom into specific time periods'),
                error && React.createElement('div', { className: 'error' }, error),
                React.createElement('div', {
                    ref: chartRef,
                    style: { height: '500px', display: data.length > 0 ? 'block' : 'none' }
                }),
                data.length === 0 && !isLoading && !error && 
                    React.createElement('div', { className: 'text-center text-gray-500 py-12' })
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('search-root'));
        root.render(React.createElement(WordSearchViz));
    </script>
  </div>

  <div>  
    <div class="text-block">
      <a href="https://www.1tv.ru/live" class="image-link">
        <img src="{% static 'img/1tv.png' %}" alt="1tv">
      </a>
      <p>
        <a href="https://storage.googleapis.com/rtlm/2023_ORT.zip">2023.11.05 - 2024 # ORT</a>
      </p>
    </div>

    <div class="text-block">
      <a href="https://www.tvr.by/televidenie/belarus-1" class="image-link">
        <img src="{% static 'img/belarus-1.png' %}" alt="belarus-1">
      </a>
      <p>
        <a href="https://storage.googleapis.com/rtlm/2023_belarusone.zip">2023.11.12 - 2024 # Belarus 1</a>
      </p>
    </div>

    <div class="text-block">
      <a href="https://1plus1.video/tvguide/1plus1/online" class="image-link">
        <img src="{% static 'img/1plus1.png' %}" alt="1plus1">
      </a>
      <p>
        <a href="https://storage.googleapis.com/rtlm/2023_oneplusone.zip">2023.11.12 - 2024 # 1+1</a>
      </p>
    </div>

    <div class="text-block">
      <a href="https://smotrim.ru/live/63254" class="image-link">
        <img src="{% static 'img/rossia.png' %}" alt="ros1">
      </a>
      <p>
        <a href="https://storage.googleapis.com/rtlm/2023_russiaone.zip">2023.11.26 - 2024 # Russia 1</a>
      </p>
    </div>

    <div class="text-block">
      <p>{{ ds|linebreaksbr }}</p>
    </div>
  </div>

  </main>

  <footer>

    <a href="https://patreon.com/rtlm" class="image-link">
        <img src="{% static 'img/pat.png' %}" alt="Patreon">
    </a>
    <a href="https://t.me/rtlminfo" class="image-link">
        <img src="{% static 'img/tel.png' %}" alt="Telegram">
    </a>  

  </footer>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
  const themeSwitcher = document.getElementById('theme-switcher');
  const sunIcon = document.getElementById('sun-icon');
  const moonIcon = document.getElementById('moon-icon');
  let currentTheme = localStorage.getItem('theme') || 'day-mode';

  updateTheme(currentTheme);

  themeSwitcher.addEventListener('click', function() {
    currentTheme = currentTheme === 'day-mode' ? 'night-mode' : 'day-mode';
    localStorage.setItem('theme', currentTheme);
    updateTheme(currentTheme);
  });

  function updateTheme(theme) {
    if (theme === 'night-mode') {
      document.body.classList.remove('day-mode');
      document.body.classList.add('night-mode');
      sunIcon.style.display = 'none';
      moonIcon.style.display = 'block';
    } else {
      document.body.classList.remove('night-mode');
      document.body.classList.add('day-mode');
      sunIcon.style.display = 'block';
      moonIcon.style.display = 'none';
    }
  }
});


  </script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var languageSelect = document.getElementById('language-select');
        languageSelect.addEventListener('change', function() {
          this.form.submit();
        });
      });
    </script>
</body>
</html>